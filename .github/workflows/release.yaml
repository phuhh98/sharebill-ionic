name: Versioning, Build, Release & Artifact

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - production

jobs:
  version_and_build:
    name: ğŸ”¢ Calculate Version & Build
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    outputs:
      next_version_tag: ${{ steps.version_calc.outputs.next_tag }}
      is_prerelease: ${{ steps.version_calc.outputs.is_prerelease }} # ğŸ’¡ New Output

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "npm"

      - name: ğŸ“¦ Install Bump Utility & JQ
        run: |
          npm install -g conventional-recommended-bump
          sudo apt-get install -y jq

      - name: ğŸ”¢ Calculate Next Version and Set Environment
        id: version_calc
        run: |
          TARGET_BRANCH=${{ github.base_ref }}

          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          CLEAN_VERSION=${LATEST_TAG#v}

          echo '{"version": "'$CLEAN_VERSION'"}' > package.json
          BUMP=$(conventional-recommended-bump -p angular)
          NEXT_VERSION_BASE=$(npm version --no-git-tag-version --allow-same-version $BUMP --json | jq -r .newversion)

          # ğŸ’¡ UPDATED LOGIC
          IS_PRERELEASE="false"

          if [ "$TARGET_BRANCH" == "main" ]; then
            NEXT_TAG="v${NEXT_VERSION_BASE}-dev.0"
            IS_PRERELEASE="true"
            RELEASE_NAME="Development Build"
          else
            NEXT_TAG="v${NEXT_VERSION_BASE}"
            RELEASE_NAME="Stable Release"
          fi

          # Output values
          echo "next_tag=$NEXT_TAG" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT # New

      # --- VITE BUILD STEPS (Omitted for brevity, remains the same) ---

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ› ï¸ Run Vite Build
        run: npm run build

      # --- ARTIFACT & RELEASE CREATION ---

      - name: ğŸ“¤ Upload Build Artifact (Vite Output)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.version_calc.outputs.next_tag }}
          path: dist
          retention-days: 7

      - name: ğŸ·ï¸ Tag Commit with New Version
        if: always()
        run: |
          git tag ${{ steps.version_calc.outputs.next_tag }}
          git push origin ${{ steps.version_calc.outputs.next_tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš€ Create GitHub Release (Dev and Prod)
        # ğŸ’¡ CONDITION REMOVED: This step now runs for BOTH main and production
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version_calc.outputs.next_tag }}
          release_name: ${{ steps.version_calc.outputs.release_name }} ${{ steps.version_calc.outputs.next_tag }}
          body: |
            # Release Details
            This release was created from the **${{ github.base_ref }}** branch.

            Tag: `${{ steps.version_calc.outputs.next_tag }}`
          draft: false
          # ğŸ’¡ CRITICAL: Use the output variable to correctly mark 'main' releases as prerelease
          prerelease: ${{ steps.version_calc.outputs.is_prerelease }}
